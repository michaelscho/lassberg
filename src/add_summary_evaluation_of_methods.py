"""
This script evaluates different text summarization methods on a dataset of 10 letters.

Methods evaluated:
1. Local summarization using the Hugging Face Transformers library (e.g., T5, BART, Pegasus)
2. Summarization using OpenAI GPT-3 API

The script performs the following steps:
1. Load the dataset of 10 letters
2. Summarize each letter using each summarization method
3. Evaluate the quality of the summaries generated by each method
4. Create a Markdown file with the description of each method and its evaluation outcome

Usage:
1. Install the required Python packages: `pip install transformers openai`
2. Set the OpenAI API key as an environment variable: `export OPENAI_API_KEY='your_api_key_here'`
3. Run the script: `python add_summary_evaluation_of_methods.py`
4. Check the generated Markdown file for the evaluation results: `evaluation_results.md`

Author: Michael Schonhardt
Date: 01.04.2023
"""

import os
#import openai
import config

#openai.api_key = config.openai_key

# 1. Load the dataset of 10 letters
with open(os.path.join(os.getcwd(), "..", "data", "literature", "test_summary_letters.txt"), "r", encoding="utf-8") as file:
    text = file.read()
    letters = text.split("\n")

for letter in letters:
    print(f"The letter has {len(letter)} characters, making a total of {len(letter)/4} token.")


# 2.1: Use chatgpt 3.5 via openai api (English)
"""
def summarize_letter_gpt_3_5_English(letter_text, max_summary_length=150):
    content = f"Summarize the following correspondence between Joseph von Laßberg and Johan Adam Pupikofer in English in {max_summary_length} words:\n\n{letter_text}\n\nSummary:"
    message = [{"role": "user", "content": content}]
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",  
        messages=message,
        temperature=0.7,
        n=1,
        stop=None,
    )
    summary = response.choices[0].message.content
    return summary

summaries = []

for letter in letters:
    summary = summarize_letter_gpt_3_5_English(letter)
    print(summary)
    summaries.append(summary)
text = "\n".join(summaries)

# Save the summaries to file
with open(os.path.join(os.getcwd(), "..", "analysis", "gpt3","test_summary_letters_gpt_3_5_English.txt"), "w", encoding="utf-8") as file:
    file.write(text)

# 2.2: Use chatgpt 3.5 via openai api (German)
def summarize_letter_gpt_3_5_German(letter_text, max_summary_length=150):
    content = f"Summarize the following correspondence between Joseph von Laßberg and Johan Adam Pupikofer in German in {max_summary_length} words:\n\n{letter_text}\n\nSummary:"
    message = [{"role": "user", "content": content}]
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",  
        messages=message,
        temperature=0.7,
        n=1,
        stop=None,
    )
    summary = response.choices[0].message.content
    return summary

summaries = []

for letter in letters:
    summary = summarize_letter_gpt_3_5_German(letter)
    print(summary)
    summaries.append(summary)
text = "\n".join(summaries)

# Save the summaries to file
with open(os.path.join(os.getcwd(), "..", "analysis", "gpt3", "test_summary_letters_gpt_3_5_German.txt"), "w", encoding="utf-8") as file:
    file.write(text)

"""
    
# Use chatgpt 4 via openai api
# Done using chatGPT given lack of api access

# Hugging Face GPT-2
from transformers import GPT2LMHeadModel, GPT2Tokenizer

def gpt2_summarize(text, model_name='gpt2', max_length=450):
    tokenizer = GPT2Tokenizer.from_pretrained(model_name)
    model = GPT2LMHeadModel.from_pretrained(model_name)

    inputs = tokenizer.encode("Summarize the following correspondence between Joseph von Laßberg and Johan Adam Pupikofer English in 150 words: " + text, return_tensors="pt", max_length=512, truncation=True)
    outputs = model.generate(inputs, max_length=max_length, num_return_sequences=1, early_stopping=True, no_repeat_ngram_size=3)

    summary = tokenizer.decode(outputs[0])
    return summary.strip()

# Usage example:
text = "Eppishausen am 25. April 1838. Hier mein vererter freund und nachbar! erhalten Sie zuerst den catalog der frau Hofrátin von Thaleppe zu Stockach, in welchem Sie viel schónes und gutes finden werden. laßen Sie sich durch die darinne befindlichen Randzeichen + & > nicht irre machen und wenn Sie etwas damit bezeichnetes wúnschen sollten, sich nicht davon abhalten: nur muß ich bitten mir den catalog spátestens in 8 tagen wieder zurúkzusenden, damit ich selben kann nach Stokach abgehen laßen. da die besizerin es mir úberlaßen hat, die preise selbst zu bestimmen ; so werde ich bei denselben die gewónl: Auctions Catalog-preise zu grunde legen. Mit vielem danke für Sie lege ich noch die Ida von Tokenburg hier wieder bei, aber mit wenig dank gegen den Verfasser. was hat doch der nárrische mann, mit zurúkstoßung aller geschichte, fúr ein lácherliches unding aus dem schonen romantischen stoffe dieser sage gemacht, und wie oft verrát er die meister, nach welchen er die studien zu seinem bilde [: crassa et invita Minerva!: ] gemacht hat, Gott beware kúnftig die vaterländische geschichte vor solchen úberlieferungen, deren verfaßer man mit recht, wie jener italienische Abbate, und vielleicht mit mer recht: Traditore nennen könnte. - Nun lieber freund? soll ich es sagen? es will mir vorkommen, als wenn unsere Bischofszeller freunde uns das scheiden dadurch erleichtern wollten, daß sie in den lezten zeiten uns immer sparsamer mit irem besuche erfreuen; aber es wird inen nicht gelingen! wie konnten wir, besonders ich, ie vergeßen, ie aufhóren mich wieder danach zu senen, wie oft in einer so langen reihe von iaren, ir freundschaftlicher umgang mich erheitert hat, und zu wúnschen, daß auch in der zukunft, der kleine arm des schwábischen meeres inen nicht zu breit sein und Sie nicht abhalten möchte, die alten dankbaren freunde zuweilen durch lre gegenwart zu erfreuen, ubi Aliquando dextrae conjungere dextram Fas erit & notas audire et reddere voces! Damit gott befolen von Irem ergebensten freunde JvLaßberg. Darf ich bitten H Praes. Scherb die Inlage samt meinem besten danke zustellen zu lassen?"
print(gpt2_summarize(text))

# Hugging Face T5.
from transformers import T5ForConditionalGeneration, T5Tokenizer

def t5_summarize(text, model_name='t5-base', max_length=450):
    tokenizer = T5Tokenizer.from_pretrained(model_name)
    model = T5ForConditionalGeneration.from_pretrained(model_name)

    inputs = tokenizer.encode("Summarize the following correspondence between Joseph von Laßberg and Johan Adam Pupikofer English in 150 words: " + text, return_tensors="pt", max_length=512, truncation=True)
    outputs = model.generate(inputs, max_length=max_length, num_return_sequences=1, early_stopping=True)

    summary = tokenizer.decode(outputs[0])
    return summary.strip()

# Usage example:
text = "Eppishausen am 25. April 1838. Hier mein vererter freund und nachbar! erhalten Sie zuerst den catalog der frau Hofrátin von Thaleppe zu Stockach, in welchem Sie viel schónes und gutes finden werden. laßen Sie sich durch die darinne befindlichen Randzeichen + & > nicht irre machen und wenn Sie etwas damit bezeichnetes wúnschen sollten, sich nicht davon abhalten: nur muß ich bitten mir den catalog spátestens in 8 tagen wieder zurúkzusenden, damit ich selben kann nach Stokach abgehen laßen. da die besizerin es mir úberlaßen hat, die preise selbst zu bestimmen ; so werde ich bei denselben die gewónl: Auctions Catalog-preise zu grunde legen. Mit vielem danke für Sie lege ich noch die Ida von Tokenburg hier wieder bei, aber mit wenig dank gegen den Verfasser. was hat doch der nárrische mann, mit zurúkstoßung aller geschichte, fúr ein lácherliches unding aus dem schonen romantischen stoffe dieser sage gemacht, und wie oft verrát er die meister, nach welchen er die studien zu seinem bilde [: crassa et invita Minerva!: ] gemacht hat, Gott beware kúnftig die vaterländische geschichte vor solchen úberlieferungen, deren verfaßer man mit recht, wie jener italienische Abbate, und vielleicht mit mer recht: Traditore nennen könnte. - Nun lieber freund? soll ich es sagen? es will mir vorkommen, als wenn unsere Bischofszeller freunde uns das scheiden dadurch erleichtern wollten, daß sie in den lezten zeiten uns immer sparsamer mit irem besuche erfreuen; aber es wird inen nicht gelingen! wie konnten wir, besonders ich, ie vergeßen, ie aufhóren mich wieder danach zu senen, wie oft in einer so langen reihe von iaren, ir freundschaftlicher umgang mich erheitert hat, und zu wúnschen, daß auch in der zukunft, der kleine arm des schwábischen meeres inen nicht zu breit sein und Sie nicht abhalten möchte, die alten dankbaren freunde zuweilen durch lre gegenwart zu erfreuen, ubi Aliquando dextrae conjungere dextram Fas erit & notas audire et reddere voces! Damit gott befolen von Irem ergebensten freunde JvLaßberg. Darf ich bitten H Praes. Scherb die Inlage samt meinem besten danke zustellen zu lassen?"
print(t5_summarize(text))



# Hugging Face Bart

from transformers import BartForConditionalGeneration, BartTokenizer

def bart_summarize(text, model_name='facebook/bart-large-cnn', max_length=450):
    tokenizer = BartTokenizer.from_pretrained(model_name)
    model = BartForConditionalGeneration.from_pretrained(model_name)

    inputs = tokenizer(text, return_tensors="pt", max_length=512, truncation=True)
    outputs = model.generate(inputs['input_ids'], max_length=max_length, num_return_sequences=1, early_stopping=True)

    summary = tokenizer.decode(outputs[0], skip_special_tokens=True)
    return summary.strip()

# Usage example:
text = "Eppishausen am 25. April 1838. Hier mein vererter freund und nachbar! erhalten Sie zuerst den catalog der frau Hofrátin von Thaleppe zu Stockach, in welchem Sie viel schónes und gutes finden werden. laßen Sie sich durch die darinne befindlichen Randzeichen + & > nicht irre machen und wenn Sie etwas damit bezeichnetes wúnschen sollten, sich nicht davon abhalten: nur muß ich bitten mir den catalog spátestens in 8 tagen wieder zurúkzusenden, damit ich selben kann nach Stokach abgehen laßen. da die besizerin es mir úberlaßen hat, die preise selbst zu bestimmen ; so werde ich bei denselben die gewónl: Auctions Catalog-preise zu grunde legen. Mit vielem danke für Sie lege ich noch die Ida von Tokenburg hier wieder bei, aber mit wenig dank gegen den Verfasser. was hat doch der nárrische mann, mit zurúkstoßung aller geschichte, fúr ein lácherliches unding aus dem schonen romantischen stoffe dieser sage gemacht, und wie oft verrát er die meister, nach welchen er die studien zu seinem bilde [: crassa et invita Minerva!: ] gemacht hat, Gott beware kúnftig die vaterländische geschichte vor solchen úberlieferungen, deren verfaßer man mit recht, wie jener italienische Abbate, und vielleicht mit mer recht: Traditore nennen könnte. - Nun lieber freund? soll ich es sagen? es will mir vorkommen, als wenn unsere Bischofszeller freunde uns das scheiden dadurch erleichtern wollten, daß sie in den lezten zeiten uns immer sparsamer mit irem besuche erfreuen; aber es wird inen nicht gelingen! wie konnten wir, besonders ich, ie vergeßen, ie aufhóren mich wieder danach zu senen, wie oft in einer so langen reihe von iaren, ir freundschaftlicher umgang mich erheitert hat, und zu wúnschen, daß auch in der zukunft, der kleine arm des schwábischen meeres inen nicht zu breit sein und Sie nicht abhalten möchte, die alten dankbaren freunde zuweilen durch lre gegenwart zu erfreuen, ubi Aliquando dextrae conjungere dextram Fas erit & notas audire et reddere voces! Damit gott befolen von Irem ergebensten freunde JvLaßberg. Darf ich bitten H Praes. Scherb die Inlage samt meinem besten danke zustellen zu lassen?"
print(bart_summarize(text))


# Hugging Face Pegasus (German)
from transformers import AutoTokenizer, AutoModelForSeq2SeqLM, pipeline
# GermanT5/t5-efficient-gc4-german-base-nl36 Einmalumdiewelt/PegasusXSUM_GNAD
def summarize_german_text(text: str, model_name="GermanT5/t5-efficient-gc4-german-base-nl36"):
    tokenizer = AutoTokenizer.from_pretrained(model_name)
    model = AutoModelForSeq2SeqLM.from_pretrained(model_name)

    summarizer = pipeline("summarization", model=model, tokenizer=tokenizer)

    summary = summarizer(text, max_length=150, min_length=40, do_sample=False)
    return summary[0]['summary_text']

# Example usage
text = "Eppishausen am 25. April 1838. Hier mein vererter freund und nachbar! erhalten Sie zuerst den catalog der frau Hofrátin von Thaleppe zu Stockach, in welchem Sie viel schónes und gutes finden werden. laßen Sie sich durch die darinne befindlichen Randzeichen + & > nicht irre machen und wenn Sie etwas damit bezeichnetes wúnschen sollten, sich nicht davon abhalten: nur muß ich bitten mir den catalog spátestens in 8 tagen wieder zurúkzusenden, damit ich selben kann nach Stokach abgehen laßen. da die besizerin es mir úberlaßen hat, die preise selbst zu bestimmen ; so werde ich bei denselben die gewónl: Auctions Catalog-preise zu grunde legen. Mit vielem danke für Sie lege ich noch die Ida von Tokenburg hier wieder bei, aber mit wenig dank gegen den Verfasser. was hat doch der nárrische mann, mit zurúkstoßung aller geschichte, fúr ein lácherliches unding aus dem schonen romantischen stoffe dieser sage gemacht, und wie oft verrát er die meister, nach welchen er die studien zu seinem bilde [: crassa et invita Minerva!: ] gemacht hat, Gott beware kúnftig die vaterländische geschichte vor solchen úberlieferungen, deren verfaßer man mit recht, wie jener italienische Abbate, und vielleicht mit mer recht: Traditore nennen könnte. - Nun lieber freund? soll ich es sagen? es will mir vorkommen, als wenn unsere Bischofszeller freunde uns das scheiden dadurch erleichtern wollten, daß sie in den lezten zeiten uns immer sparsamer mit irem besuche erfreuen; aber es wird inen nicht gelingen! wie konnten wir, besonders ich, ie vergeßen, ie aufhóren mich wieder danach zu senen, wie oft in einer so langen reihe von iaren, ir freundschaftlicher umgang mich erheitert hat, und zu wúnschen, daß auch in der zukunft, der kleine arm des schwábischen meeres inen nicht zu breit sein und Sie nicht abhalten möchte, die alten dankbaren freunde zuweilen durch lre gegenwart zu erfreuen, ubi Aliquando dextrae conjungere dextram Fas erit & notas audire et reddere voces! Damit gott befolen von Irem ergebensten freunde JvLaßberg. Darf ich bitten H Praes. Scherb die Inlage samt meinem besten danke zustellen zu lassen?"
summary = summarize_german_text(text)
print(summary)



